## The idea

The shellcode loaded by `serpentine.exe` is obfuscated in two ways. First of all, it contains self-modifying code, with a lot of redundant instructions and jumps. First we want to clean this part and make the code more readable.
The second issue to solve, is exception-based flow obfuscation. The shellcode contains HLT instructions that trigger custom exception handlers. Its role is to not only obfuscate the flow, but also to manipulate the context. We will leave their original logic intact, and yet integrate them into the deobfuscated code.

This deobfuscator will be used to rebuild the original binary (`serpentine.exe`) and make it easier to follow.
Instead of calling the shellcode that is embedded, we will call its processed version. 
Two sections will be appended to the `serpentine.exe` binary.
1. The deobfuscated code
2. The patched original code

The first section will contain the cleaned code blocks, without the HLT instructions. Whenever there is a need to call HLT, the execution will be redirected to the section 2, to call HLT from the original offset and have it handled by the original exception handler. 

From parsine the exception information we can learn how the code is redirected. For example:

```txt
# HLT at 0x0 ->	Handler: 0x98
# HLT at 0x107 ->	Handler: 0x1a7
# HLT at 0x20a ->	Handler: 0x2a2
# HLT at 0x315 ->	Handler: 0x3a8
[...]
```

How is this logic applied in the deobfuscated code (Section#1, starting at VA `0x1410aa000`):

```asm
; 0x1410aa000:
jmp 0x1408aa000 ;jump to section#2, to call the HLT at offset 0

; 0x1410aa005:
movabs r11, 0x10add7f49 
push r11
push 0x73775436
push 0x68a04c43
push 0x12917ff9
add qword ptr [rsp + 0x18], 0x35ac399f
jmp 0x1408aa107 ;jump to section#2, to call the HLT at offset 0x107

; 0x1410aa02e:
mov rbp, qword ptr [r9 + 0x28]
mov rdi, qword ptr [rbp + 0xe0]
movzx rdi, dil
jmp 0x1408aa20a  ;jump to section#2, to call the HLT at offset 0x20a

0x1410aa042:
[...]
```

To preserve the code continuity in the deobfuscated section, we will also add patches in the Section#2 that calls the HLTs.

```asm
; 0x1408aa000 :
hlt
[...]
; 0x1408aa098 :
jmp 0x1410aa005

; 0x1408aa107 :
hlt
[...]
; 0x1408aa1a7 :
jmp 0x1410aa02e

; 0x1408aa20a :
hlt
[...]
; 0x1408aa2a2 :
jmp 0x1410aa042
```



## Deobfuscator (`capstone_deobf.py`)

Run the `capstone_deobf.py`:

```
python capstone_deobf.py --debug False > out.txt
```
As an input, it requires the original shellcode from serpentine.exe (default: `serpentine_00000000069D0000.bin`).

As an output, it will create:
+ an assembly file (default: `111_code.asm`) - that is cleaned version of the shellcode
+ list of patches to to be applied on the original shellcode (default: `111_halts.asm`)

## Assembler (`keystone_asm.py`)

An assembler based on Keystone Engine.
Run by:

```
python keystone_asm.py
```

As an input it requires the assembly generated by the deobfuscator (default: `111_code.asm`).
As an output is returns a file with the assembled code (default: `111_code.shc`)

## Patcher (`keystone_patcher.py`)

Applies list patches (default: `111_halts.asm`) generated by `capstone_deobf.py` on the original shellcode (default: `serpentine_00000000069D0000.bin`).

